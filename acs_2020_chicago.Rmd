---
title: "Analysis of New Census Data Part 1"
author: "Ethan Jantz"
date: "3/31/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(leaflet)
library(tidyverse)
library(tidycensus)
library(patchwork)

ref_vars <- load_variables(2015, "acs5")

acs_vars <- c(
  total_population = "B01001_001",
  white_population = "B02001_002",
  black_population = "B02001_003",
  amind_population = "B02001_004",
  asian_population = "B02001_005",
  api_population = "B02001_006",
  other_population = "B02001_007",
  two_population = "B02001_008",
  nothispanic_population = "B03001_002",
  hispanic_population = "B03001_003",
  total_households = "B25003_001",
  owner_households = "B25003_002",
  renter_households = "B25003_003",
  vacant_units = "B25004_001",
  vacant_units_forrent = "B25004_002",
  total_families = "B05010_001",
  belowpoverty_families = "B05010_002",
  median_income = "B25119_001",
  median_owner_income = "B25119_002",
  median_renter_income = "B25119_003",
  median_gross_rent = "B25031_001",
  median_gross_2br_rent = "B25031_004",
  median_home_value = "B25107_001"
)

inflation_table <- blscrapeR::inflation_adjust(2020) %>%
  filter(year %in% c(2015, 2020))
inflation_adjust_value <- inflation_table %>% 
  filter(year == 2015) %>%
  pull(adj_value)

chi_2020 <- get_acs("place",
                    variables = acs_vars,
                    year = 2020, 
                    output = "wide") %>%
  mutate(year = 2020)

chi_2015 <- get_acs("place",
                    variables = acs_vars,
                    year = 2015, 
                    output = "wide") %>%
  mutate(year = 2015,
         across(ends_with(c("income", "value", "rent")), ~ .x / inflation_adjust_value))

data <- bind_rows(chi_2020, chi_2015) %>%
  filter(NAME == "Chicago city, Illinois") %>%
  select(city = NAME, year, ends_with("E")) %>%
  rename_with(gsub, pattern = "E$", replacement = "") %>%
  mutate(grouped_other_population = amind_population + api_population + other_population)
```

# Socio-economic Change in Chicago, 2015 - 2020

The release of the 2020 5-year American Community Survey data allows for an assessment of changes in Chicago's socio-economic composition of both individuals and households. This blog is the first in a series exploring changes in Chicago's demographic and economic composition. 

## Demographic Change

```{r population total}
data %>%
  select(year, total_population) %>%
  mutate(total_population = scales::comma(total_population))
```

Chicago lost an estimated 18,187 residents between 2015 and 2020. Demographically, Chicago has seen declines in groups identifying as white, black, hispanic, and other (a category that includes anyone identifying as neither white, black, asian, native hawaiian/pacific islander, or native american) while groups identifying as asian, native hawaiian/pacific islander, and two or more races increase. People identifying as two or more races saw the biggest change in Chicago's population, growing from 2.4% in 2015 to 5.2% in 2020. 

```{r demographic}
data %>%
  mutate(
    white_pct = white_population / total_population,
    black_pct = black_population / total_population,
    asian_pct = asian_population / total_population,
    api_pct = api_population / total_population,
    other_pct = other_population / total_population,
    two_pct = two_population / total_population,
    # other_pct = grouped_other_population / total_population,
    hispanic_pct = hispanic_population / total_population,
    nothispanic_pct = nothispanic_population / total_population,
    total_pct = white_pct + black_pct + other_pct,
    # across(ends_with("_population"), scales::comma),
    # across(ends_with("_pct"), scales::percent)
         ) %>%
  select(
    year, #total_population, 
    white_pct, #white_population, 
    black_pct, #black_population, 
    asian_pct, #asian_population, 
    api_pct, #api_population,
    two_pct, #two_population, 
    other_pct, #other_population
    hispanic_pct, #hispanic_population, 
    # nothispanic_pct, #nothispanic_population 
  ) %>%
  pivot_longer(
    cols = c(white_pct:hispanic_pct),
    names_to = "Race",
    names_pattern = "(.*)_pct"
  ) %>%
  pivot_wider(
    names_from = "year",
    values_from = "value"
  ) %>%
  mutate(Change = `2020` - `2015`,
         across(c(`2020`:Change), scales::percent, accuracy = .01))
```

## Household Change

```{r household total}
data %>%
  select(year, total_households) %>%
  mutate(total_households = scales::comma(total_households))
```

Chicago gained an estimated 45,000 households between 2015 and 2020. In the context of a net population loss it's likely that household size has decreased on average. We will examine this and other questions on household composition in later posts.

```{r tenure}
data %>%
  mutate(
    renter_pct = renter_households / total_households,
    owner_pct = owner_households / total_households,
    vacant_forrent_pct = vacant_units_forrent / vacant_units,
    # total_households = scales::comma(total_households),
    vacant_units = scales::comma(vacant_units),
    across(ends_with(c("rent", "income", "value")), scales::dollar),
    across(ends_with("_pct"), scales::percent)) %>%
  select(year, renter_pct, median_gross_rent, owner_pct, median_home_value, vacant_units, vacant_forrent_pct)
```

Chicago saw a modest increase in its share of homeowners with a corresponding decrease in renter households. Median gross rent increased by 19% (\$189) and the median home value grew by 20% (\$44,700). The number of vacant units decreased by approximately 20,000 units, and the share of those units that were empty rental units decreased from 27% to 25%. This indicates increasing pressure on low-income households as rental units become less available and less affordable. 

```{r income}
data %>%
  select(year, median_income, median_renter_income, median_owner_income) %>%
  mutate(across(ends_with("income"), scales::dollar))
```

The median income for Chicago increased by 27% (\$13,575). Renters saw a larger percent increase in median income than owners at 31% (\$10,417) and 22% ($16,711) respectively. 

```{r poverty}
data %>%
  mutate(poverty_pct = belowpoverty_families / total_families,
         across(ends_with("families"), scales::comma),
         across(ends_with("pct"), scales::percent)) %>%
  select(year, total_families, poverty_pct, belowpoverty_families)
```

Chicago saw a decrease of 46,595 families (a household of related individuals) between 2015 and 2020. The share of those families living in poverty dropped by 8%, indicating an out-migration of low-income families from the city.

## Chicago Community Areas Crosswalk

[The Census Bureau provides an explanation of the 2010 to 2020 tract relationships here.](https://www2.census.gov/geo/pdfs/maps-data/data/rel2020/tract/explanation_tab20_tract20_tract10.pdf) This file is joined to the tract relationship file provided by the [City of Chicago Data Portal](https://data.cityofchicago.org/Facilities-Geographic-Boundaries/Boundaries-Census-Tracts-2010/5jrd-6zik) to identify which 2020 decennial tracts are related to the Chicago Community Areas (CCAs) that the 2010 decennial tracts aggregate to.

```{r crosswalk}
chi_tracts_2010 <- read_csv("https://data.cityofchicago.org/resource/74p9-q2aq.csv", col_types = "cccccccccc")

cook_tracts_2010 <- tigris::tracts(state = "IL", county = "Cook", year = 2010) 

chi_tracts_2010 <- cook_tracts_2010 %>%
  right_join(chi_tracts_2010, by = c("GEOID10" = "geoid10"))

cook_tracts_2020 <- tigris::tracts(state = "IL", county = "Cook", year = 2020)

rel_file <- read.delim("https://www2.census.gov/geo/docs/maps-data/data/rel2020/tract/tab20_tract20_tract10_st17.txt", sep = "|", colClasses = "character")

new_rel_file <- chi_tracts_2010 %>%
  select(GEOID10, commarea) %>%
  left_join(rel_file %>%
               select(GEOID_TRACT_10, GEOID_TRACT_20), 
             by = c("GEOID10" = "GEOID_TRACT_10")) 

chi_tracts_2020 <- new_rel_file %>%
  sf::st_drop_geometry() %>%
  left_join(cook_tracts_2020,
            by = c("GEOID_TRACT_20" = "GEOID")) %>%
  select(-GEOID10, GEOID = GEOID_TRACT_20, everything())

p2010 <- chi_tracts_2010 %>%
  group_by(commarea) %>%
  summarize() %>%
  ggplot(aes(geometry = geometry)) +
  geom_sf(aes(fill = commarea)) +
  theme(legend.position = "none")

p2020 <- cook_tracts_2020 %>%
  select(GEOID, geometry) %>%
  left_join(chi_tracts_2020, by = c("GEOID")) %>%
  drop_na() %>%
  group_by(commarea) %>%
  summarize() %>%
  ggplot(aes(geometry = geometry.x)) +
  geom_sf(aes(fill = commarea)) +
  theme(legend.position = "none")

p2010 + p2020
```